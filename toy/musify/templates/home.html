{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style_home.css">
    <!-- <style>
        
    </style> -->
</head>
<body>
    <aside class="sidebar">
        <div>
            <i class="fas fa-music"></i>
            <span style="font-weight: bolder; font-size: 20px;">Musify</span>
        </div>
        
        <nav>
            <a href="#" class="nav-item active">
                <span>üè†</span>
                Home
            </a>
            <a href="up_music" class="nav-item">
                <span>üì§</span>
                Upload Music
            </a>
            <a href="/musify/playlist/" class="nav-item">
                <span>üìö</span>
                Your Library
            </a>
        </nav>
        <div class="playlists">
            <div class="playlists-header" onclick="togglePlaylists()">
                <h3>Your Playlists</h3>
                <button class="expand-btn" id="expand-btn">‚ñº</button>
            </div>
            <div id="playlist-items" class="hidden">
                <a href="#" class="playlist-item">new songs <button class="delete-btn" onclick="deletePlaylist(event)">üóëÔ∏è</button></a>
                <a href="#" class="playlist-item">Abir Chowdhury <button class="delete-btn" onclick="deletePlaylist(event)">üóëÔ∏è</button></a>
            </div>
            <div class="create-playlist">
                <h3>Create New Playlist</h3>
                <form method="POST" action="{% url 'create_playlist' %}">
                    {% csrf_token %}
                    <input type="text" name="playlist_name" placeholder="My Awesome Playlist">
                    <button type="submit">Create</button>
                </form>
            </div>
        </div>
        
    </aside>
    <main class="main-content">
        <header class="header">
            <input type="search" class="search-bar" placeholder="Search songs, artists, or albums">
            <div class="header-right">
                <button class="notification-btn">üîî</button>
                <button class="profile-btn" onclick="toggleProfilePopup()">
                    <img src="{% static 'images/profile.png' %}" alt="Profile" style="width: 30px; height: 30px; border-radius: 50%;">
                </button>
            </div>
        </header>
        <section class="featured-songs">
            <h2>Featured Songs</h2>
            <div class="songs-grid" id="songs-grid">
                <!-- Songs will be dynamically added here -->
            </div>
        </section>
    </main>

    <!-- Profile Popup -->
    <div class="profile-popup hidden" id="profilePopup">
      <ul>
        <li><a href="profile">View Profile</a></li>
        <li><a href="#">Settings</a></li>
        <li>
          <!-- Link to your logout route; adjust as needed in urls.py -->
          <a href="logout" onclick="event.preventDefault(); confirmLogout();">
            Logout
          </a>
        </li>
      </ul>
    </div>

    <script>
        // Initialize audio player first
        let currentSongIndex = 0;
        let songs = [];

        // Navigation handling
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                document.querySelector('.nav-item.active').classList.remove('active');
                e.currentTarget.classList.add('active');
            });
        });

        // Search functionality
        const searchBar = document.querySelector('.search-bar');
        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const songCards = document.querySelectorAll('.song-card');
            
            songCards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const artist = card.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || artist.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Notification button
        document.querySelector('.notification-btn').addEventListener('click', () => {
            alert('Notifications clicked!');
        });

        // Profile button
        document.querySelector('.profile-btn').addEventListener('click', () => {
        });

        // Add playlist button
        function addPlaylist() {
            const playlistName = prompt('Enter new playlist name:');
            if (playlistName) {
                const playlistItem = document.createElement('a');
                playlistItem.href = '#';
                playlistItem.className = 'playlist-item';
                playlistItem.innerHTML = `${playlistName} <button class="delete-btn" onclick="deletePlaylist(event)">üóëÔ∏è</button>`;
                document.querySelector('#playlist-items').appendChild(playlistItem);
            }
        }

        // Toggle playlists visibility
        function togglePlaylists() {
            const playlistItems = document.getElementById('playlist-items');
            const expandBtn = document.getElementById('expand-btn');
            playlistItems.classList.toggle('hidden');
            expandBtn.classList.toggle('rotate');
        }

        // Delete playlist
        function deletePlaylist(event) {
            event.stopPropagation();
            const playlistItem = event.target.closest('.playlist-item');
            playlistItem.remove();
        }

        // Music player functionality
        // Update the loadSongsFromDatabase function
        async function loadSongsFromDatabase() {
            try {
                const response = await fetch('/musify/get_songs');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                
                if (data.error) {
                    console.error('Server error:', data.error);
                    const songsGrid = document.getElementById('songs-grid');
                    songsGrid.innerHTML = `<p class="error-message">Error: ${data.error}</p>`;
                    return;
                }
                
                if (!data.songs || data.songs.length === 0) {
                    const songsGrid = document.getElementById('songs-grid');
                    songsGrid.innerHTML = '<p class="no-songs-message">No songs available</p>';
                    return;
                }
                
                if (data.songs && data.songs.length > 0) {
                    songs = data.songs;
                    
                    // Add songs to global player
                    if (window.MusicPlayer && typeof window.MusicPlayer.addSongs === 'function') {
                        window.MusicPlayer.addSongs(songs);
                        console.log('Songs added to persistent player');
                    }
                    
                    console.log('Songs loaded:', songs);
                    populateSongsGrid();
                }
                
            } catch (error) {
                console.error('Error loading songs:', error);
                const songsGrid = document.getElementById('songs-grid');
                songsGrid.innerHTML = `<p class="error-message">Error loading songs: ${error.message}</p>`;
            }
        }

        // REPLACE your song card click handler with this one
        function populateSongsGrid() {
            const songsGrid = document.getElementById('songs-grid');
            songsGrid.innerHTML = ''; // Clear existing content
            
            songs.forEach(song => {
                const songCard = document.createElement('div');
                songCard.className = 'song-card';
                songCard.dataset.songId = song.id || '';
                songCard.dataset.songName = song.name;
                songCard.dataset.songArtist = song.artist;
                songCard.dataset.songUrl = song.source;
                
                songCard.innerHTML = `
                    <img src="${song.cover}" alt="${song.name}">
                    <h3>${song.name}</h3>
                    <p>${song.artist}</p>
                    <button class="play-btn">‚ñ∂</button>
                `;
                
                // Use a proper event listener instead of onclick attribute
                songCard.addEventListener('click', function() {
                    playSong(song.name, song.artist);
                });
                
                songsGrid.appendChild(songCard);
            });
        }

        // Load songs when the document is ready
        document.addEventListener('DOMContentLoaded', loadSongsFromDatabase);

        // Keep only this function but modify it:
        function playSong(name, artist) {
            try {
                console.log("Home page playSong called:", name, artist);
                
                const song = songs.find(s => s.name === name && s.artist === artist);
                
                if (song) {
                    // Check if MusicPlayer is available
                    if (!window.MusicPlayer) {
                        console.error("MusicPlayer object not defined");
                        return;
                    }
                    
                    // Use the global player
                    window.MusicPlayer.playSong(null, {
                        id: song.id,
                        name: song.name,
                        title: song.name, 
                        artist: song.artist,
                        cover: song.cover,
                        cover_url: song.cover,
                        source: song.source,
                        song_url: song.source
                    });
                    
                    // Force show the player
                    const musicPlayer = document.getElementById('music-player');
                    if (musicPlayer) {
                        musicPlayer.classList.add('active');
                        musicPlayer.style.display = 'flex';
                        musicPlayer.style.visibility = 'visible';
                    }
                } else {
                    console.error("Song not found:", name, artist);
                }
            } catch (error) {
                console.error("Error in playSong:", error);
            }
        }

        // Dynamically add songs to the grid
        const songsGrid = document.getElementById('songs-grid');
        songs.forEach(song => {
            const songCard = document.createElement('div');
            songCard.className = 'song-card';
            songCard.innerHTML = `
                <img src="${song.cover}" alt="${song.name}">
                <h3>${song.name}</h3>
                <p>${song.artist}</p>
                <button class="play-btn" onclick="playSong('${song.name}', '${song.artist}')">‚ñ∂</button>
            `;
            songsGrid.appendChild(songCard);
        });

        // Song card click handling
        document.querySelectorAll('.song-card').forEach(card => {
            card.addEventListener('click', () => {
                const name = card.querySelector('h3').textContent;
                const artist = card.querySelector('p').textContent;
                playSong(name, artist);
            });
        });

        // Toggles the popup's visibility
        function toggleProfilePopup() {
            const popup = document.getElementById('profilePopup');
            popup.classList.toggle('hidden');
        }

        // Confirms logout before redirecting
        function confirmLogout() {
            if (confirm("Are you sure you want to logout?")) {
                window.location.href = "login";
            }
        }
    </script>
    <!-- Add this to your script section -->
    <script>
        // Replace the duplicate DOMContentLoaded event listeners with this single one
        document.addEventListener('DOMContentLoaded', function() {
            // Load songs first
            loadSongsFromDatabase();
            
            // Connect to the persistent player
            setTimeout(() => {
                if (window.MusicPlayer && typeof window.MusicPlayer.connectPlaylist === 'function') {
                    console.log("Connecting home page to persistent player");
                    window.MusicPlayer.connectPlaylist();
                } else {
                    console.error("Persistent music player not available");
                    
                    // Debug info
                    console.log("Available on window:", Object.keys(window).filter(key => key.includes('Music')));
                    console.log("MusicPlayer defined:", typeof window.MusicPlayer);
                    if (window.MusicPlayer) {
                        console.log("MusicPlayer methods:", Object.keys(window.MusicPlayer));
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>